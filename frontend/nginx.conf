map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Shared configuration for serving the SPA and proxying webhook calls.
# This snippet is included from both the HTTP and HTTPS server blocks so the
# behaviour stays identical across protocols.
upstream backend_api {
    server backend:8000;
}

server {
    listen 80;
    server_name _;

    include /etc/nginx/snippets/app-common.conf;
}

server {
    listen 443 ssl;
    server_name _;

    ssl_certificate /etc/nginx/certs/selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    include /etc/nginx/snippets/app-common.conf;
}
