# Интеграция Bitrix24 → Обеды сотрудников

Эта инструкция показывает, как из Bitrix24 отправлять вебхук на бекенд проекта, чтобы сотрудники появлялись в веб-интерфейсе автоматически.

## Требования

- Проект "Обеды сотрудников" должен быть развёрнут и доступен извне Bitrix24. Если сервис работает локально, воспользуйтесь туннелированием (например, `ngrok`, `localtunnel`, `cloudflared`) и пробросьте порт 8000.
- Для запросов используется эндпоинт `POST /webhook/employee`.
- Секрет вебхука по умолчанию — `obed-webhook-secret`. Его можно поменять, задав переменную окружения `WEBHOOK_SECRET` при запуске docker-compose.

## Шаг 1. Получите публичный URL

1. Запустите проект: `docker compose up --build`.
2. Определите адрес, по которому Bitrix24 сможет достучаться до бекенда. Если используете туннель, получите HTTPS‑ссылку вида `https://<subdomain>.ngrok.app` и убедитесь, что она проксирует на `http://localhost:8000`.
3. Полный URL вызова будет иметь вид `https://<ваш-домен>/webhook/employee`.

## Шаг 2. Создайте исходящий вебхук в Bitrix24

1. Войдите в портал Bitrix24 под администратором.
2. Откройте **Приложения → Вебхуки**.
3. Нажмите **Добавить вебхук** и выберите тип **Исходящий вебхук**.
4. Укажите произвольное название (например, «Обеды сотрудников»).
5. В поле «URL вашего обработчика» впишите адрес из предыдущего шага (`https://<ваш-домен>/webhook/employee`).
6. В поле «Секрет» укажите `obed-webhook-secret` (или значение, которое вы настроили в переменной `WEBHOOK_SECRET`).
7. Сохраните настройки. Bitrix24 покажет пример запроса — он нам не понадобится, потому что мы будем отправлять JSON вручную.

> ⚠️ Исходящий вебхук Bitrix24 отправляет данные методом `POST` с `application/x-www-form-urlencoded`. Чтобы передать JSON, удобнее использовать роботов/бизнес-процессы с действием «HTTP-запрос», см. следующий раздел.

## Шаг 3. Настройте робот или бизнес-процесс

Самый гибкий вариант — добавить робот, который выполнит HTTP-запрос на наш сервис.

1. Откройте нужную воронку/процесс (например, «CRM → Сделки → Автоматизация»).
2. Добавьте действие **HTTP-запрос**.
3. В поле URL укажите `https://<ваш-домен>/webhook/employee`.
4. Выберите метод `POST`.
5. В поле заголовков добавьте строку `Content-Type: application/json`.
6. В тело запроса вставьте JSON вида:

```json
{
  "secret": "obed-webhook-secret",
  "action": "add",
  "employee": {
    "full_name": "{{FIO}}",
    "status": true,
    "date": "{{DATE_CREATE}}",
    "note": "Создано из сделки #{{ID}}"
  }
}
```

- `{{FIO}}`, `{{DATE_CREATE}}`, `{{ID}}` — пример подстановки полей Bitrix24. Замените их на нужные переменные CRM/Задач.
- Поле `status` принимает `true` (участвует в обеде) или `false`.
- `date` — дата в формате `YYYY-MM-DD`. Можно передавать конкретную дату или вычислять её роботами.

После сохранения запустите робот — сотрудник появится в разделе и будет показан в UI без обновления фильтров.

## Проверка

- Вы можете проверить запрос командой:

```bash
curl -X POST https://<ваш-домен>/webhook/employee \
  -H "Content-Type: application/json" \
  -d '{
        "secret": "obed-webhook-secret",
        "action": "add",
        "employee": {
          "full_name": "Иванов Алмас",
          "status": true,
          "date": "2024-04-01"
        }
      }'
```

- В ответ вы получите `{"status":"added","id":<число>}`. Значит, запись создана и уже отображается в веб-интерфейсе.

## Обновление и удаление

Для изменения или удаления записей отправьте аналогичный запрос, поменяв поле `action`:

- `"action": "update"` + укажите `"employee_id"` и объект `"update"` с нужными полями (например, `{ "status": false }`).
- `"action": "delete"` + укажите `"employee_id"`.

```json
{
  "secret": "obed-webhook-secret",
  "action": "update",
  "employee_id": 18,
  "update": {
    "status": false,
    "note": "Не участвует в обеде"
  }
}
```

Bitrix24 должен отправлять JSON ровно в таком формате, чтобы данные корректно попали в таблицу.
